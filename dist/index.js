import H from"dotenv";import S from"express";import{clerkMiddleware as J}from"@clerk/express";import{createServer as N}from"http";import{requireAuth as v}from"@clerk/express";import{randomUUID as R}from"crypto";var E=class{users;conversations;messages;constructor(){this.users=new Map,this.conversations=new Map,this.messages=new Map}async getUser(r){return this.users.get(r)}async getUserByUsername(r){return Array.from(this.users.values()).find(t=>t.username===r)}async createUser(r){let t=R(),e={...r,id:t};return this.users.set(t,e),e}async createConversation(r){let t=R(),e={...r,id:t,createdAt:new Date};return this.conversations.set(t,e),e}async getConversation(r){return this.conversations.get(r)}async getUserConversations(r){return Array.from(this.conversations.values()).filter(t=>t.userId===r).sort((t,e)=>e.createdAt.getTime()-t.createdAt.getTime())}async createMessage(r){let t=R(),e={...r,id:t,createdAt:new Date};return this.messages.set(t,e),e}async getConversationMessages(r){return Array.from(this.messages.values()).filter(t=>t.conversationId===r).sort((t,e)=>t.createdAt.getTime()-e.createdAt.getTime())}},l=new E;async function b(n,r){let t=process.env.OPENROUTER_API_KEY;if(!t)throw new Error("OPENROUTER_API_KEY is not configured. Please set the OPENROUTER_API_KEY environment variable. Get your key at: https://openrouter.ai/keys");if(t.trim().length===0)throw new Error("OPENROUTER_API_KEY is empty. Please provide a valid API key.");let e=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json","HTTP-Referer":process.env.FRONTEND_URL?process.env.FRONTEND_URL:"http://localhost:5000","X-Title":"AWAKE Chatbot"},body:JSON.stringify({model:n,messages:r})});if(!e.ok){let o=await e.text();throw console.error("OpenRouter API error:",o),new Error(`OpenRouter API error: ${e.status} - ${o}`)}let s=await e.json();if(!s.choices||s.choices.length===0)throw new Error("No response from OpenRouter API");return s.choices[0].message.content}async function x(n){let r=process.env.SERP_API_KEY;if(!r)return`Web search is not configured. To enable web search, set up one of these services:

1. **SerpAPI** (Recommended): Get a free API key from https://serpapi.com
2. **Google Custom Search**: Use Google's Custom Search API
3. **Bing Search**: Use Bing Search API

Once configured, web search will provide real-time information from the internet.`;try{let t=await fetch(`https://serpapi.com/search?q=${encodeURIComponent(n)}&api_key=${r}&gl=us&num=5`);if(!t.ok)throw new Error(`SerpAPI error: ${t.status}`);let e=await t.json();if(!e.organic_results||e.organic_results.length===0)return`No search results found for "${n}"`;let s=`\u{1F50D} **Web Search Results for "${n}":**

`;return e.organic_results.slice(0,5).forEach((o,a)=>{s+=`${a+1}. **${o.title}**
`,s+=`   ${o.snippet||o.description||""}
`,s+=`   Link: ${o.link}

`}),s}catch(t){return console.error("Web search error:",t),"Web search encountered an error. Please try again or try a different query."}}import{z as g}from"zod";function y(n){let r=n.auth;return typeof r=="function"?r()?.userId||null:r?.userId||null}var k=g.object({conversationId:g.string().nullable().optional(),modelId:g.string().min(1,"Model ID is required"),modelName:g.string().min(1,"Model name is required"),message:g.string().min(1,"Message cannot be empty").max(5e4,"Message is too long (max 50,000 characters)"),webSearchEnabled:g.boolean().optional().default(!1)}),U=new Map,L=6e4,D=30;function F(n){let r=Date.now(),e=(U.get(n)||[]).filter(s=>r-s<L);return e.length>=D?!1:(e.push(r),U.set(n,e),!0)}async function C(n){return n.get("/api/health",(t,e)=>{e.json({status:"ok",timestamp:new Date().toISOString()})}),n.get("/api/conversations",v(),async(t,e)=>{try{let s=y(t);if(!s)return e.status(401).json({error:"Unauthorized"});let o=await l.getUserConversations(s);e.json(o)}catch(s){console.error("Error fetching conversations:",s),e.status(500).json({error:"Failed to fetch conversations"})}}),n.get("/api/conversations/:id/messages",v(),async(t,e)=>{try{let s=y(t);if(!s)return e.status(401).json({error:"Unauthorized"});let{id:o}=t.params,a=await l.getConversation(o);if(!a)return e.status(404).json({error:"Conversation not found"});if(a.userId!==s)return e.status(403).json({error:"Access denied"});let c=await l.getConversationMessages(o);e.json(c)}catch(s){console.error("Error fetching messages:",s),e.status(500).json({error:"Failed to fetch messages"})}}),n.post("/api/upload",v(),async(t,e)=>{try{let s=y(t);if(!s)return e.status(401).json({error:"Unauthorized"});let{files:o}=t.body;if(!o||!Array.isArray(o)||o.length===0)return e.status(400).json({error:"No files provided"});let a=[],c=5*1024*1024,i=["image/jpeg","image/png","image/webp","image/gif"];for(let u of o){if(!i.includes(u.type))return e.status(400).json({error:`File type ${u.type} not allowed. Allowed types: JPEG, PNG, WebP, GIF`});let m=0;try{let h=u.data.split(",")[1];m=Buffer.from(h,"base64").length}catch{return e.status(400).json({error:"Invalid file data format"})}if(m>c)return e.status(413).json({error:`File size exceeds 5MB limit. Size: ${(m/1024/1024).toFixed(2)}MB`});let p=`${s}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;a.push({id:p,name:u.name,type:u.type,size:m,url:u.data,uploadedAt:new Date})}e.json({success:!0,files:a,message:`Successfully uploaded ${a.length} file(s)`})}catch(s){if(console.error("Error in file upload:",s),s instanceof Error)return s.message.includes("PayloadTooLarge")||s.message.includes("413")?e.status(413).json({error:"Total payload too large. Please upload smaller files or fewer images."}):e.status(500).json({error:s.message});e.status(500).json({error:"Failed to upload files"})}}),n.post("/api/chat",v(),async(t,e)=>{try{let s=y(t);if(!s)return e.status(401).json({error:"Unauthorized"});if(!F(s))return e.status(429).json({error:"Too many requests. Please wait a moment before sending another message."});let o=k.parse(t.body),a=o.conversationId||void 0;if(!a)a=(await l.createConversation({userId:s,modelId:o.modelId,modelName:o.modelName})).id;else{let f=await l.getConversation(a);if(!f)return e.status(404).json({error:"Conversation not found"});if(f.userId!==s)return e.status(403).json({error:"Access denied"})}let c=await l.createMessage({conversationId:a,role:"user",content:o.message}),u=(await l.getConversationMessages(a)).map(f=>({role:f.role,content:f.content})),m="",p="";o.webSearchEnabled&&(p=await x(o.message),u.push({role:"assistant",content:p})),m=await b(o.modelId,u);let h=m;p&&(h=`${p}

---

**AI Analysis:**

${m}`);let $=await l.createMessage({conversationId:a,role:"assistant",content:h});e.json({conversationId:a,userMessage:c,aiMessage:$,webSearchUsed:o.webSearchEnabled,searchResults:p||void 0})}catch(s){if(s instanceof g.ZodError){let o=s.errors.map(a=>`${a.path.join(".")}: ${a.message}`).join("; ");return e.status(400).json({error:`Invalid request data: ${o}`})}console.error("Error in chat:",s),e.status(500).json({error:s instanceof Error?s.message:"Failed to process chat message"})}}),N(n)}import z from"express";import j from"fs";import P from"path";import{createServer as G,createLogger as Y}from"vite";import{defineConfig as q}from"vite";import B from"@vitejs/plugin-react";import w from"path";import{fileURLToPath as W}from"url";import{dirname as K}from"path";var I=K(W(import.meta.url)),A=q({plugins:[B()],resolve:{alias:{"@":w.resolve(I,"client","src"),"@shared":w.resolve(I,"shared"),"@assets":w.resolve(I,"attached_assets")}},root:"client",build:{outDir:w.resolve(I,"dist/public"),emptyOutDir:!0,minify:"terser",sourcemap:!1,rollupOptions:{output:{manualChunks:{"vendor-ui":["react","react-dom","react-hook-form"],"vendor-radix":["@radix-ui/react-dialog","@radix-ui/react-dropdown-menu","@radix-ui/react-popover","@radix-ui/react-select","@radix-ui/react-tabs","@radix-ui/react-tooltip"],"vendor-query":["@tanstack/react-query"]}}}},server:{fs:{strict:!0,deny:["**/.*"]}}});import{nanoid as V}from"nanoid";var _=Y();function M(n,r="express"){let t=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${t} [${r}] ${n}`)}async function O(n,r){let t={middlewareMode:!0,hmr:{server:r},allowedHosts:!0},e=await G({...A,configFile:!1,customLogger:{..._,error:(s,o)=>{_.error(s,o),process.exit(1)}},server:t,appType:"custom"});n.use(e.middlewares),n.use("*",async(s,o,a)=>{let c=s.originalUrl;try{let i=P.resolve(import.meta.dirname,"..","client","index.html"),u=await j.promises.readFile(i,"utf-8");u=u.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${V()}"`);let m=await e.transformIndexHtml(c,u);o.status(200).set({"Content-Type":"text/html"}).end(m)}catch(i){e.ssrFixStacktrace(i),a(i)}})}function T(n){let r=P.resolve(import.meta.dirname,"public");if(!j.existsSync(r))throw new Error(`Could not find the build directory: ${r}, make sure to build the client first`);n.use(z.static(r)),n.use("*",(t,e)=>{e.sendFile(P.resolve(r,"index.html"))})}H.config();var d=S();d.use(J({publishableKey:process.env.VITE_CLERK_PUBLISHABLE_KEY}));d.use(S.json({limit:"50mb",verify:(n,r,t)=>{n.rawBody=t}}));d.use(S.urlencoded({extended:!1,limit:"50mb"}));d.use((n,r,t)=>{let e=Date.now(),s=n.path,o,a=r.json;r.json=function(c,...i){return o=c,a.apply(r,[c,...i])},r.on("finish",()=>{let c=Date.now()-e;if(s.startsWith("/api")){let i=`${n.method} ${s} ${r.statusCode} in ${c}ms`;o&&(i+=` :: ${JSON.stringify(o)}`),i.length>80&&(i=i.slice(0,79)+"\u2026"),M(i)}}),t()});(async()=>{let n=await C(d);d.use((e,s,o,a)=>{let c=e.status||e.statusCode||500,i=e.message||"Internal Server Error";throw o.status(c).json({message:i}),e}),d.get("env")==="development"?await O(d,n):T(d);let r=parseInt(process.env.PORT||"5000",10),t=process.env.NODE_ENV==="development"?"localhost":"0.0.0.0";n.listen(r,t,()=>{M(`serving on http://${t}:${r}`)})})();
